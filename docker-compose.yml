version: "3.9"

services:
  web:
    build:
      context: .
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY:-}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
        SUPABASE_URL: ${SUPABASE_URL:-}
        SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
        SUPABASE_PUBLISHABLE_KEY: ${SUPABASE_PUBLISHABLE_KEY:-}
        SUPABASE_SECRET_KEY: ${SUPABASE_SECRET_KEY:-}
        SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-}
        NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL: ${NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL:-}
        STRAVA_VERIFY_TOKEN: ${STRAVA_VERIFY_TOKEN:-}
        N8N_WEBHOOK_SECRET: ${N8N_WEBHOOK_SECRET:-}
        POSTGRES_URL: ${POSTGRES_URL:-}
        POSTGRES_PRISMA_URL: ${POSTGRES_PRISMA_URL:-}
        POSTGRES_URL_NON_POOLING: ${POSTGRES_URL_NON_POOLING:-}
        POSTGRES_HOST: ${POSTGRES_HOST:-}
        POSTGRES_DATABASE: ${POSTGRES_DATABASE:-}
        POSTGRES_USER: ${POSTGRES_USER:-}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-}
        STRAVA_CLIENT_ID: ${STRAVA_CLIENT_ID:-}
        STRAVA_CLIENT_SECRET: ${STRAVA_CLIENT_SECRET:-}
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.running.entrypoints=web,websecure
      - traefik.http.services.running.loadbalancer.server.port=3000
      - traefik.http.routers.running.rule=Host(`running.silasbeckmann.de`)
      - traefik.http.routers.running.tls=true
      - traefik.docker.network=traefik_proxy-net
      - traefik.http.middlewares.running.headers.SSLRedirect=true
      - traefik.http.middlewares.running.headers.STSSeconds=315360000
      - traefik.http.middlewares.running.headers.browserXSSFilter=true
      - traefik.http.middlewares.running.headers.contentTypeNosniff=true
      - traefik.http.middlewares.running.headers.forceSTSHeader=true
      - traefik.http.middlewares.running.headers.SSLHost=${DOMAIN_NAME:-running.silasbeckmann.de}
      - traefik.http.middlewares.running.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.running.headers.STSPreload=true
      - traefik.http.routers.running.middlewares=running@docker
    environment:
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY:-}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
      SUPABASE_PUBLISHABLE_KEY: ${SUPABASE_PUBLISHABLE_KEY:-}
      SUPABASE_SECRET_KEY: ${SUPABASE_SECRET_KEY:-}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-}
      NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL: ${NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL:-}
      STRAVA_VERIFY_TOKEN: ${STRAVA_VERIFY_TOKEN:-}
      N8N_WEBHOOK_SECRET: ${N8N_WEBHOOK_SECRET:-}
      POSTGRES_URL: ${POSTGRES_URL:-}
      POSTGRES_PRISMA_URL: ${POSTGRES_PRISMA_URL:-}
      POSTGRES_URL_NON_POOLING: ${POSTGRES_URL_NON_POOLING:-}
      POSTGRES_HOST: ${POSTGRES_HOST:-}
      POSTGRES_DATABASE: ${POSTGRES_DATABASE:-}
      POSTGRES_USER: ${POSTGRES_USER:-}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-}
      STRAVA_CLIENT_ID: ${STRAVA_CLIENT_ID:-}
      STRAVA_CLIENT_SECRET: ${STRAVA_CLIENT_SECRET:-}
    networks:
      - traefik_proxy-net

networks:
  traefik_proxy-net:
    external: true
